echo "📦 Stashing unstaged changes..."
git stash push --keep-index --include-untracked -q
STASHED=$?

trap 'if [ $STASHED -eq 0 ]; then echo "🔄 Restoring unstaged changes..."; git stash pop --index -q || echo "⚠️ Failed to restore stash. Please check manually."; fi' EXIT

echo "🧪 Running full test suite via pnpm script..."
pnpm test
TEST_STATUS=$?

if [ $TEST_STATUS -eq 0 ]; then
  echo "✅ All tests passed. Push will proceed."
else
  echo "❌ Tests failed. Push blocked."
fi

exit $TEST_STATUS
